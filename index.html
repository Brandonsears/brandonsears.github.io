<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Keep all the previous head content and styles the same as before -->
</head>
<body>
    <!-- Keep all the previous body HTML the same until the script tag -->

    <script>
        // Add your API key here
        const API_KEY = 'QVPBQVP0TEWP5B52'; // Replace with your Alpha Vantage API key

        const sectorStocks = {
            "Technology": ["AAPL", "MSFT", "GOOGL"],
            "Financial": ["JPM", "BAC", "GS"],
            "Healthcare": ["JNJ", "PFE", "UNH"],
        };

        async function fetchStockData(symbol) {
            try {
                const response = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${API_KEY}`);
                const data = await response.json();
                const quote = data['Global Quote'];
                
                if (!quote) {
                    throw new Error('No data received');
                }

                return {
                    name: symbol,
                    price: parseFloat(quote['05. price']),
                    marketCap: parseFloat(quote['05. price']) * 1000000, // Simplified market cap
                    change: parseFloat(quote['10. change percent'].replace('%', '')),
                    volume: parseInt(quote['06. volume'])
                };
            } catch (error) {
                console.error(`Error fetching ${symbol}:`, error);
                return null;
            }
        }

        // Keep all the other functions (formatMarketCap, formatVolume, getColor) the same

        async function updateVisualization() {
            const loadingOverlay = d3.select("#market-map")
                .append("div")
                .attr("class", "loading-overlay")
                .append("div")
                .attr("class", "loading-spinner");

            try {
                const data = { name: "Market Map", children: [] };
                
                // Add delay between requests to respect API limits
                for (const [sector, symbols] of Object.entries(sectorStocks)) {
                    const stocksData = [];
                    for (const symbol of symbols) {
                        const stockData = await fetchStockData(symbol);
                        if (stockData) stocksData.push(stockData);
                        // Add delay between requests
                        await new Promise(resolve => setTimeout(resolve, 1500));
                    }
                    
                    if (stocksData.length > 0) {
                        data.children.push({
                            name: sector,
                            children: stocksData
                        });
                    }
                }

                // Rest of the visualization code remains the same
                // ... (keep all the d3.js visualization code the same)

            } catch (error) {
                console.error("Error creating visualization:", error);
                d3.select("#market-map")
                    .html("<div class='error'>Error loading market data</div>");
            }
        }

        // Initial load
        updateVisualization();

        // Refresh every 15 minutes (to stay within API limits)
        setInterval(updateVisualization, 900000);
    </script>
</body>
</html>
